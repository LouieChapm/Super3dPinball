pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
ws={}
res=32

-- ball
b={x=20,y=-16,u=0,v=0,r=4,w=0,a=0}
-- gravity
g=0.3
-- substeps
ss=16
wy=8
wv=0
hist={}
did_collide=false

-- build scene
for i=0,res do
 local cx=64+63*cos(i/res/2)
 local cy=64-63*sin(i/res/2)
 local sx=-sin(i/res/2)
 local sy=cos(i/res/2)
 add(ws,{cx-64*sx,cy+64*sy,cx+64*sx,cy-64*sy})
end


function _update()
 did_collide=false
 for _=1,ss do
  wy+=wv/ss
  wv-=(wy+24)/ss/32
  local x0=b.x
  local y0=b.y-wy
  local u=b.u
  local v=b.v
  local a=b.a
  local w=b.w
  v+=g/ss
  local x=x0+u/ss
  local y=y0+v/ss
  local a=a+w/ss
  local dx=x-64
  local dy=y-64
  local br=dx*dx+dy*dy
  local nx=0
  local ny=0
  local coll=false
  -- check for collisions and
  -- find:
  -- - collision normal: nx,ny
  -- - post-collision pos: x,y
  if br>3481 and y>64 then
   -- circular wall segment
   local ratio=sqrt(3481/br)
   x=64+ratio*dx
   y=64+ratio*dy
   local a=atan2(dx,dy)
   nx=cos(a)
   ny=sin(a)
   coll=true
  elseif x<5 then
   -- left wall
   x=5
   nx=1
   ny=0
   coll=true
  elseif x>124 then
   -- right wall
   x=124
   nx=-1
   ny=0
   coll=true
  end
  b.x=x
  b.y=y+wy
  -- find new ball velocity
  -- relative to wall
  local u1=(x-x0)*ss
  local v1=(y-y0)*ss-wv
  -- this block deals with
  -- collisions
  if coll then
   -- make u1/v1 tangential by
   -- subtracting out their
   -- projection onto the normal
   local dn1=u1*nx+v1*ny
   u1-=dn1*nx
   v1-=dn1*ny
   -- find velocity of ball
   -- surface at point of
   -- contact
   local ub=b.r*w*-ny*6.28
   local vb=b.r*w*nx*6.28
   -- hacky friction model:
   -- mix in a little bit of
   -- the ball surface velocity
   -- to the tangential part
   -- of the ball center
   -- velocity
   local ut=(.1*ub+.9*u1)
   local vt=(.1*vb+.9*v1)
   u1=ut
   v1=vt
   -- another hack: fix up
   -- rotational velocity by
   -- just trying to make it
   -- consistent with the new
   -- ball center tangential
   -- velocity under a no-slip
   -- constraint
   w=vt/(b.r*nx*6.28)+
     ut/(b.r*-ny*6.28)
   w/=2
   -- reflect the normal
   -- component of the ball's
   -- velocity, losing a little
   -- so the collision is
   -- slightly inelastic
   local dn=u*nx+v*ny
   u1-=.75*dn*nx
   v1-=.75*dn*ny
  end
  b.u=u1
  b.v=v1+wv
  b.a=a
  b.w=w
  did_collide=did_collide or coll
 end
 add(hist,{b.x,b.y})
end

function _draw()
 -- debug collision test
 -- (warning: flashes)
 -- cls(did_collide and 1 or 0)
 cls()
 for w in all(ws) do
  line(w[1],w[2]+wy,w[3],w[4]+wy,6)
 end
 circfill(b.x,b.y,b.r,8)
 line(
  b.x,b.y,
  b.x+cos(b.a)*b.r,
  b.y+sin(b.a)*b.r,
  11
 )
 for p in all(hist) do
  pset(p[1], p[2], 15)
 end
 if (#hist>160) deli(hist,1)
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
06000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000000000f0000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
060000000000000f000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000f00000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
060000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
060000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
060000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
060000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
060000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
060000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fff0006
0600000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff0f0006
06000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000f00f0006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000f0006
06000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f00000f00006
060000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000f00000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f00006
060000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f00000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000000000f000006
0600000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f00000000000000000000006
06000000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
0600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000006
6600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000f00f0f000000000000000006
660000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000000000f0f00000000f0000000000000006
66000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000f000000000000000f000000f0000006
66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f0f000000000000000000f00000000006
6600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000006
660000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000006
6600000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000f0000000000000000000000000f0000006
66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
66000000000000000000000000000000000000000ff000000000000000000000000000000000000000000000000f000000000000000000000000000000f00006
66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ff0000066
6600000000000000000000000000000000f0000000000000f0000000000000000000000000000000000000000f00f00000000000000000000000000000000066
66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f00000066
66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066
66000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000f00000066
6600000000000000000000000000000000000000000f0000000000000000000000000000000000000000000f00000000000000000000000000000f0000000066
6600000000000000000000000000000f000000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000066
660000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000000000f00000000066
06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066
66000000000000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000f000000066
66000000000000000000000000000000000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000066
06600000000000000000000000000f00000000000000f00000000000000000000000000000000000000000f000000000000000000000000000f0000000000666
0660000000000000000000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000000666
666000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000000000000000000f000000000000000666
66660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000f000000000f000000000006606
066600000000000000000000000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000006666
06660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006666
66660000000000000000000000f00000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000006606
066660000000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000f0000000000066666
066660000000000000000000000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066666
06666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066606
66066600000000000000000000000f0000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000666606
0606660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f000000000000666066
06666600000000000000000000000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000000666606
6606666000000000000000000000000f000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000006666006
06066660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006666066
0666606600000000000000000000000000f00000000000f0000000000000000000000000000000000000000000000000000000000000f0000000000066066606
06060606000000000000000000000000000000000000000000000000000000000000000000000f0000000000000000000000000008880b000000000060606006
66066666600000000000000000000000000000000000000000000000000000000000000000000f000000000000000000000000088888b8000000000666666006
060606066000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000000088888b8000000000660606066
06660666660000000000000000000000000000000000000000000000000000000000000000f00000000000000000000000000088888b88800000006666606606
0606060666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008888f888800000006660606006
06006660666000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000088888888800000066606660006
66006060666600000000000000000000000000000000000f00000000000000000000000f0f000000000000000000000000000008888888000000666606060066
06606066066600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008888888000000666066060606
06066060666660000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000088800000006666606066006
66006660066666000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000000000066666006660006
0660606600660660000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000660660066060666
06066006606066600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000666060660066006
0600660606606666000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000000006666066060660006
060060660066066060000000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000060660660066060006
660060066606660666000000000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000666066606660060006
066660006066066606600000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000006606660660600066666
060066006006666660660000000000000000000000000f0000000000000000000000000000000000000000000000000000000000000066066666600600660006
06000666600060606666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066660606000666600006
060006006660600666666600000000000000000000000000000000000000000f0000000000000000000000000000000000000000006666666006066600600006
66600600600660060660666000000000000000000000000000000000000000000000000000000000000000000000000000000000066606606006600600600666
060666000600066600666666000000000000000000000000f0000000000000000000000000000000000000000000000000000000666666006660006000666006
06000666660006006660066660000000000000000000000000000000000000f00000000000000000000000000000000000000006666006660060006666600006
0600060006666600606660666600000000000000000000000f0000000000f0000000000000000000000000000000000000000066660666060066666000600006
66000600060006660606066066660000000000000000000000000000000000000000000000000000000000000000000000006666066060606660006000600006
06666600060000606660600666666000000000000000000000000000000000000000000000000000000000000000000000066666600606660600006000666666
06000666666000600066660066666660000000000000000000f00000000000000000000000000000000000000000000006666666006666000600066666600006
06000060006666660060066666606666000000000000000000000000000f00000000000000000000000000000000000066660666666006006666660000600006
060000600060000666666060066666666600000000000000000000000f0000000000000000000000000000000000006666666660060666666000060006000006
06000060006000060006066666606666066600000000000000000000000000000000000000000000000000000000666066660666666060006000060006000006
66666666606000060006000600666666666666000000000000000000000000000000000000000000000000000066666666666600600060006000060666666666
0600006006666666666060060006006666666666000000000000f000000000000000000000000000000000006666666666006000600606666666666006000006
06000060000600006006666666666060060066666600000000f00000000000000000000000000000000000666666006006066666666660060000600006000006
060000600006000060006000600066666666666066666600000000ff000000000000000000000000006666660666666666660006000600060000600006000006
06000060000600000600060006000600600600666666666666660000000000000000000000006666666666666600600600600060006000600000600006000006
06000060000600000600060006000060060060006006066666666666660000000000006666666666666060060006006006000060006000600000600006000006
66666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666
06000060000060000600006000600006000600600066006006666666666606666660666666666660060066000600600060000600060000600006000006000006

